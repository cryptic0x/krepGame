import{setLocalStorageItem}from"../../../scripts/setLocalStorageItem.js";import{getLocalStorageItem}from"../../../scripts/getLocalStorageItem.js";const queryString=window.location.search,urlParams=new URLSearchParams(queryString),theme=urlParams.get("theme"),special=urlParams.get("special"),isDesktop=!window.matchMedia("(any-hover: none)").matches,isMobile=window.matchMedia("(any-hover: none)").matches,canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),states=(isDesktop?(canvas.width=800,canvas.height=600):(canvas.width=374,canvas.height=564),ctx.textAlign="center",{init:"Init",running:"Running",score:"Score",start:"Start"});let state=states.init;const game="Meme Invaders";let player=localStorage.getItem("player");null===player&&(player="Unknown Player");const gameWrapper=document.querySelector("#game-wrapper");if(gameWrapper.classList.add("border-2"),gameWrapper.classList.add("border-black"),isMobile){const maxFactor=11,windowWidth=window.innerWidth,windowHeight=window.innerHeight,widthScaleFaktor=Math.round(canvas.width/windowWidth*maxFactor)/10;windowWidth>canvas.width&&windowHeight>canvas.height*(1-widthScaleFaktor+1)&&gameWrapper.classList.add(`scale-[${1-widthScaleFaktor+1}]`)}const assets=new Map;document.querySelectorAll("[data-asset]").forEach(asset=>assets.set(asset.getAttribute("data-asset"),asset));let enemiesArray=[],hitEnemiesArray=[];if("pizzaday"===special)for(let i=0;i<6;i++)enemiesArray.push("pizza"),hitEnemiesArray.push("pizza-hit");else enemiesArray=["doge","shiba-inu","pepe","floki","bonk","brett"],hitEnemiesArray=["doge-hit","shiba-inu-hit","pepe-hit","floki-hit","bonk-hit","brett-hit"];const FRAMES_PER_SECOND=80,FLEET_SIDE_MARGIN=isDesktop?40:20,FLEET_TOP_MARGIN=isDesktop?100:50,PLAYER_SIDE_MARGIN=10,PLAYER_BOT_MARGIN=0,SCORE_INCREMENT=10,ENEMY_VELOCITY_Y=10;let enemyVelocityX=10,enemyVelocityY=10;const ENEMY_HEIGHT=30,ENEMY_WIDTH=30,FLEET_ROWS=6,FLEET_COLUMNS=6,FLEET_WIDTH_RATIO=.6,FLEET_HEIGHT_RATIO=.5,FLEET_MOVE_RATE=isDesktop?70:160,PLAYER_HEIGHT=90,PLAYER_WIDTH=50,PLAYER_COLOSION_BOUNDING_BOX=5,PLAYER_VELOCITY_X=10,BULLET_VELOCITY_Y=20,BULLET_HEIGHT=10,BULLET_WIDTH=3,BULLET_RATE=isDesktop?300:500,HIT_TIMER=250;let playerTheme="",playerThemeColor="#ffffff";const PLAYER_THEME_TAOSHI="taoshi",PLAYER_THEME_ALTCOINIST="altcoinist",PLAYER_THEME_ALTCOINIST_COLOR="#64d645",PLAYER_THEME_DREADBONGO="dreadbongo",PLAYER_THEME_DREADBONGO_COLOR="#fadc40",PLAYER_THEME_CALEBSOL="calebsol",PLAYER_THEME_CALEBSOL_COLOR="#2dd9c3",PLAYER_THEME_MOGMACHINE="mogmachine",PLAYER_THEME_MOGMACHINE_COLOR="#01b7d6";"altcoinist"===theme?(playerTheme=PLAYER_THEME_ALTCOINIST,playerThemeColor=PLAYER_THEME_ALTCOINIST_COLOR):"dreadbongo"===theme?(playerTheme=PLAYER_THEME_DREADBONGO,playerThemeColor=PLAYER_THEME_DREADBONGO_COLOR):"calebsol"===theme?(playerTheme=PLAYER_THEME_CALEBSOL,playerThemeColor=PLAYER_THEME_CALEBSOL_COLOR):"mogmachine"===theme?(playerTheme=PLAYER_THEME_MOGMACHINE,playerThemeColor=PLAYER_THEME_MOGMACHINE_COLOR):playerTheme=PLAYER_THEME_TAOSHI;let hasLost=!1,hasWon=!1,hasShot=!1,fleetWidth,fleetHeight,score=0,highScore,lastHitScore=0,lastHitPosition=[0,0],hitTimer=HIT_TIMER,enemyFleet={},fleetCenterX,fleetCenterY,fleetMovementTimer=0,playerCenterX,playerCenterY,playerDirection="right",bullets=[],bulletTimer=BULLET_RATE,bulletCooldown=!1;setLocalStorageItem(game,"score",0);const savedHighScore=getLocalStorageItem(game,"highScore"),controls=(highScore=savedHighScore&&"no data"!==savedHighScore?Number(savedHighScore):(setLocalStorageItem(game,"highScore",0),0),positionFleet(),positionPlayer(),setInterval(runAll,1e3/FRAMES_PER_SECOND),document.querySelector("#game-controls")),controlsLeft=document.querySelector("#game-controls-left"),controlsRight=document.querySelector("#game-controls-right");function strokedAndFilledText(text="",x=0,y=0,color="white",strokeColor="black",font="30px Retro"){ctx.font=font,ctx.strokeText(text,x,y+4),ctx.lineWidth=6,ctx.strokeStyle=strokeColor,ctx.strokeText(text,x,y),ctx.fillStyle=color,ctx.fillText(text,x,y)}function runAll(){fleetMovementTimer+=1e3/FRAMES_PER_SECOND,reloadBullet(),moveEverything(),drawEverything(),view()}function calculateScore(plusMinus,amout){"+"===plusMinus?score+=amout:score>=amout&&(score-=amout),setLocalStorageItem(game,"score",score)}function view(){state===states.score?setTimeout(()=>{setLocalStorageItem(game,"view","Score")},1e3):state===states.running?setLocalStorageItem(game,"view","Running"):state===states.init&&setLocalStorageItem(game,"view","Start")}function positionFleet(){fleetWidth=canvas.width*FLEET_WIDTH_RATIO,fleetHeight=canvas.height*FLEET_HEIGHT_RATIO,fleetCenterX=canvas.width/2,fleetCenterY=FLEET_TOP_MARGIN+FLEET_HEIGHT_RATIO*canvas.height/2;let enemyID=0;for(let i=0;i<FLEET_COLUMNS;++i)for(let j=0;j<FLEET_ROWS;++j){enemyID+=1;var position=[j*fleetWidth/(FLEET_COLUMNS-1)+(canvas.width/2-fleetWidth/2),i*fleetHeight/(FLEET_ROWS-1)+FLEET_TOP_MARGIN];enemyID<7?(position.push(6),position.push(6)):enemyID<13?(position.push(5),position.push(5)):enemyID<19?(position.push(4),position.push(4)):enemyID<25?(position.push(3),position.push(3)):enemyID<31?(position.push(2),position.push(2)):(position.push(1),position.push(1)),enemyFleet[i*FLEET_ROWS+j]=position}}function positionPlayer(){playerCenterX=canvas.width/2,playerCenterY=canvas.height-PLAYER_HEIGHT/2-PLAYER_BOT_MARGIN}function bulletFlight(){bulletCooldown||(bullets.push([playerCenterX,playerCenterY-PLAYER_HEIGHT/2]),bulletCooldown=!0,calculateScore("-",1),assets.get("shoot").play())}function fireBullet(e){theme&&" "===e.key&&(state===states.init?state=states.running:state===states.running&&bulletFlight())}function reloadBullet(){bulletCooldown&&(bulletTimer-=1e3/FRAMES_PER_SECOND),bulletTimer<=0&&(bulletCooldown=!1,bulletTimer=BULLET_RATE)}function movePlayerLeft(){playerCenterX>PLAYER_SIDE_MARGIN&&(playerCenterX-=PLAYER_VELOCITY_X),playerDirection="left"}function movePlayerRight(){playerCenterX<canvas.width-PLAYER_SIDE_MARGIN&&(playerCenterX+=PLAYER_VELOCITY_X),playerDirection="right"}function movePlayer(e){if(theme)if(state!==states.init||"ArrowLeft"!==e.key&&"ArrowRight"!==e.key){if(state===states.running)switch(e.key){case"ArrowLeft":movePlayerLeft();break;case"ArrowRight":movePlayerRight()}}else state=states.running}function moveEverything(){hasLost||moveFleet(),state===states.running&&(moveBullet(),bulletDetection())}function moveBullet(){for(var bullet of bullets)bullet[1]-=BULLET_VELOCITY_Y}function bulletDetection(){for(let i=0;i<bullets.length;++i){var selectedBullet=bullets[i];if(selectedBullet[1]<0)bullets.splice(i,1);else for(var enemy in enemyFleet)if(selectedBullet[0]<enemyFleet[enemy][0]+ENEMY_WIDTH/2&&selectedBullet[0]>enemyFleet[enemy][0]-ENEMY_WIDTH/2&&selectedBullet[1]-BULLET_HEIGHT/2<enemyFleet[enemy][1]+ENEMY_HEIGHT/2){hasShot=!0;var hitScore=SCORE_INCREMENT*(enemyFleet[enemy][3]-enemyFleet[enemy][2]+1);lastHitPosition=[enemyFleet[enemy][0],enemyFleet[enemy][1]],lastHitScore=hitScore,hitTimer=HIT_TIMER,calculateScore("+",hitScore),assets.get("hit").play(),1<enemyFleet[enemy][2]?--enemyFleet[enemy][2]:delete enemyFleet[enemy],bullets.splice(i,1);break}}}function moveFleet(){if(fleetMovementTimer>FLEET_MOVE_RATE){for(var key in enemyFleet)enemyFleet[key][0]+=enemyVelocityX,enemyFleet[key][1]+=enemyVelocityY,enemyFleet[key][1]+ENEMY_HEIGHT/2>playerCenterY-(PLAYER_HEIGHT/2-PLAYER_COLOSION_BOUNDING_BOX)&&(enemyFleet[key][0]+ENEMY_WIDTH/2>playerCenterX-(PLAYER_WIDTH/2-PLAYER_COLOSION_BOUNDING_BOX)&&enemyFleet[key][0]-ENEMY_WIDTH/2<playerCenterX+(PLAYER_WIDTH/2-PLAYER_COLOSION_BOUNDING_BOX)||enemyFleet[key][1]+ENEMY_HEIGHT>canvas.height)&&(state=states.score);(fleetCenterX+=enemyVelocityX)-fleetWidth/2<FLEET_SIDE_MARGIN||fleetCenterX+fleetWidth/2>canvas.width-FLEET_SIDE_MARGIN?(calculateScore("-",10),enemyVelocityX*=-1,hasShot&&(assets.get("lvlup").play(),enemyVelocityY=ENEMY_VELOCITY_Y)):enemyVelocityY=0,fleetMovementTimer=0}}function checkIfAllEnemiesAreDead(){isEmpty(enemyFleet)&&(hasWon=!0,state=states.score)}function drawEverything(){ctx.drawImage(assets.get("background"),0,0),drawFleet(),drawBullet(),0!==lastHitScore&&0<hitTimer&&(drawHitScore(lastHitScore,lastHitPosition[0],lastHitPosition[1]),hitTimer-=1e3/FRAMES_PER_SECOND),state===states.init?displayInstructions():state===states.running?(checkIfAllEnemiesAreDead(),displayScore()):state===states.score&&displayGameOver(),drawPlayer()}function drawHitScore(hitScore,x,y){strokedAndFilledText("+"+hitScore,x,y+10,"white","black","20px Retro")}function drawFleet(){for(var enemy in enemyFleet){var enemyPos=enemyFleet[enemy];"pizzaday"===special&&(enemiesArray=["pizza","pizza","pizza","pizza","pizza","pizza"],hitEnemiesArray=["pizza-hit","pizza-hit","pizza-hit","pizza-hit","pizza-hit","pizza-hit"]),enemy=[0,1,2,3,4,5].includes(Number(enemy))?(enemyFleet[enemy][2]<enemyFleet[enemy][3]?hitEnemiesArray:enemiesArray)[0]:[6,7,8,9,10,11].includes(Number(enemy))?(enemyFleet[enemy][2]<enemyFleet[enemy][3]?hitEnemiesArray:enemiesArray)[1]:[12,13,14,15,16,17].includes(Number(enemy))?(enemyFleet[enemy][2]<enemyFleet[enemy][3]?hitEnemiesArray:enemiesArray)[2]:[18,19,20,21,22,23].includes(Number(enemy))?(enemyFleet[enemy][2]<enemyFleet[enemy][3]?hitEnemiesArray:enemiesArray)[3]:[24,25,26,27,28,29].includes(Number(enemy))?(enemyFleet[enemy][2]<enemyFleet[enemy][3]?hitEnemiesArray:enemiesArray)[4]:[30,31,32,33,34,35].includes(Number(enemy))?(enemyFleet[enemy][2]<enemyFleet[enemy][3]?hitEnemiesArray:enemiesArray)[5]:(enemyFleet[enemy][2]<enemyFleet[enemy][3]?hitEnemiesArray:enemiesArray)[0],ctx.drawImage(assets.get(enemy),enemyPos[0]-ENEMY_WIDTH/2,enemyPos[1]-ENEMY_HEIGHT/2)}}function drawPlayer(){var playerImage=state===states.score?hasWon?"happy":"dead":bulletCooldown?"shoot":hasShot?"armed":"default";drawImage(assets.get("player-"+playerImage),playerCenterX-PLAYER_WIDTH/2,playerCenterY-PLAYER_HEIGHT/2,"left"===playerDirection)}function drawBullet(){for(var bullet of bullets)colorRect(bullet[0],bullet[1],BULLET_WIDTH,BULLET_HEIGHT,playerThemeColor)}function displayInstructions(){colorRect(0,0,canvas.width,canvas.height,"rgba(0, 0, 0, 0.2)"),isDesktop?(strokedAndFilledText("TAOSHI",canvas.width/2,180,"white","black","100px Retro"),strokedAndFilledText("MEME INVADERS",canvas.width/2,260,"white","black","50px Retro"),playerTheme!==PLAYER_THEME_TAOSHI&&(strokedAndFilledText("STARRING",canvas.width/2,330,"white","black","20px Retro"),strokedAndFilledText(playerTheme.toUpperCase(),canvas.width/2,390,playerThemeColor,"black","40px Retro")),ctx.drawImage(assets.get("input"),canvas.width/2-55,430)):(strokedAndFilledText("TAOSHI",canvas.width/2,140,"white","black","40px Retro"),strokedAndFilledText("MEME",canvas.width/2,225,"white","black","60px Retro"),strokedAndFilledText("INVADERS",canvas.width/2,290,"white","black","40px Retro"),playerTheme!==PLAYER_THEME_TAOSHI&&(strokedAndFilledText("STARRING",canvas.width/2,330,"white","black","10px Retro"),strokedAndFilledText(playerTheme.toUpperCase(),canvas.width/2,380,playerThemeColor,"black","30px Retro")),ctx.drawImage(assets.get("input-touch"),canvas.width/2-42,390),theme&&isMobile&&(controls.classList.remove("hidden"),controls.classList.add("flex")))}function displayGameOver(){hasWon?(assets.get("won").play(),hasLost=!0):hasLost||(assets.get("dead").play(),hasLost=!0),score>highScore&&setLocalStorageItem(game,"highScore",score),hasWon?strokedAndFilledText("DEFETED",canvas.width/2,65,"white","black","30px Retro"):strokedAndFilledText("GAME OVER",canvas.width/2,65,"white","black","30px Retro"),strokedAndFilledText("SCORE "+score,canvas.width/2,110,"white","black","30px Retro")}function displayScore(){strokedAndFilledText(score,canvas.width/2,60)}function colorRect(leftX,topY,width,height,drawColor){ctx.fillStyle=drawColor,ctx.fillRect(leftX,topY,width,height)}function drawImage(img,x,y,flip){ctx.save(),ctx.scale(flip?-1:1,1),ctx.drawImage(img,flip?-1*img.width-x:x,y),ctx.restore()}function isEmpty(obj){for(var prop in obj)if(Object.prototype.hasOwnProperty.call(obj,prop))return!1;return!0}isDesktop&&(document.addEventListener("keydown",movePlayer),document.addEventListener("keydown",fireBullet)),isMobile&&(canvas.addEventListener("touchstart",function(e){state===states.init?state=states.running:bulletFlight(),canvas.removeEventListener("touchstart",null)}),controlsLeft.addEventListener("touchstart",function(e){state===states.init?state=states.running:movePlayerLeft()}),controlsRight.addEventListener("touchstart",function(e){state===states.init?state=states.running:movePlayerRight()}));