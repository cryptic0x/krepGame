import{ParallaxBackground}from"./parallaxBackground.js";import{PipeManager}from"./pipeManagers.js";import{input}from"./input.js";import{time}from"./time.js";import{Bird}from"./bird.js";import{Vector2}from"./math.js";import{setLocalStorageItem}from"../../../scripts/setLocalStorageItem.js";import{getLocalStorageItem}from"../../../scripts/getLocalStorageItem.js";const isDesktop=!window.matchMedia("(any-hover: none)").matches,isMobile=window.matchMedia("(any-hover: none)").matches,game="Flappy Taoshi";let player=localStorage.getItem("player");null===player&&(player="Unknown Player");const canvas=document.querySelector("#canvas"),ctx=canvas.getContext("2d"),gameWrapper=document.querySelector("#game-wrapper");if(gameWrapper.classList.add("border-2"),gameWrapper.classList.add("border-black"),canvas.style.imageRendering="pixelated",ctx.imageSmoothingEnabled=!1,gameWrapper.appendChild(canvas),canvas.width=288,canvas.height=430,isMobile){const maxFactor=10,windowWidth=window.innerWidth,windowHeight=window.innerHeight,widthScaleFaktor=Math.round(canvas.width/windowWidth*maxFactor)/10;windowWidth>canvas.width&&windowHeight>canvas.height*(1-widthScaleFaktor+1)&&gameWrapper.classList.add(`scale-[${1-widthScaleFaktor+1}]`)}function strokedAndFilledText(text="",x=0,y=0,color="white",strokeColor="black",font="40px Retro"){ctx.font=font,ctx.strokeText(text,x,y+4),ctx.lineWidth=6,ctx.strokeStyle=strokeColor,ctx.strokeText(text,x,y),ctx.fillStyle=color,ctx.fillText(text,x,y)}ctx.textAlign="center";const assets=new Map,bird=(document.querySelectorAll("[data-asset]").forEach(asset=>assets.set(asset.getAttribute("data-asset"),asset)),new Bird(assets.get("bird"))),background=new ParallaxBackground(assets.get("background")),clouds=new ParallaxBackground(assets.get("clouds")),ground=new ParallaxBackground(assets.get("ground")),pipeManager=(ground.scrollSpeed=-60,ground.loopingPoint=288,background.scrollSpeed=-46,background.loopingPoint=288,clouds.scrollSpeed=-40,clouds.loopingPoint=288,new PipeManager),states=(ground.position.addPosition(-1,400),{countdown:"Countdown",running:"Running",score:"Score",start:"Start",restart:"Restart"});let state=states.start,score=0,highScore=0,timeout=80;setLocalStorageItem(game,"score",0);const savedHighScore=getLocalStorageItem(game,"highScore");function animate(unscaledTime=0){function gameover(){assets.get("hit").play(),assets.get("die").play(),bird.velocity.y=-1.5,bird.dead=!0,state=states.score}time.deltaTime=Number((unscaledTime-time.lastTime)/1e3),time.deltaTime=Math.min(time.deltaTime,time.maximumDeltaTime),time.lastTime=unscaledTime,time.elapsedTime+=time.deltaTime,setLocalStorageItem(game,"view",state),state===states.start&&(score=0,pipeManager.reset(),pipeManager.start(),bird.reset(),bird.position=new Vector2(128,195),bird.sprite=assets.get("placeholder"),input.getMouseButtonClick(0))&&(state=states.running,bird.velocity.y+=bird.jumpForce),state===states.running&&(bird.update(),pipeManager.update(),ground.update(),background.update(),clouds.update(),pipeManager.pipes.forEach(pipePair=>{!pipePair.scored&&pipePair.pipeTop.position.x+pipePair.pipeTop.sprite.width/2<bird.position.x&&(pipePair.scored=!0,score+=1,assets.get("point").play()),(bird.collides(pipePair.pipeTop)||bird.collides(pipePair.pipeBottom))&&gameover()}),bird.collides(ground)&&gameover(),bird.position.y<0)&&gameover(),state===states.score&&(bird.update(),0<timeout?--timeout:input.getMouseButtonClick(0)&&window.location.reload()),ctx.clearRect(0,0,canvas.width,canvas.height),clouds.draw(),background.draw(),pipeManager.draw(),state===states.start&&(ctx.drawImage(assets.get("group"),20,232),strokedAndFilledText("Flappy",135,95),strokedAndFilledText("Krep",150,160),unscaledTime=isMobile?assets.get("input-touch"):assets.get("input-mouse"),ctx.drawImage(unscaledTime,115,145)),state===states.running&&(strokedAndFilledText(""+score,150,60,null,null,"20px Retro"),score>highScore&&(highScore=score,setLocalStorageItem(game,"highScore",highScore)),setLocalStorageItem(game,"score",score)),state===states.score&&(ctx.drawImage(assets.get("frame"),42,120),strokedAndFilledText(""+player,142,149,null,null,"9px Retro"),strokedAndFilledText("NOW",110,200,null,null,"8px Retro"),strokedAndFilledText(""+score,112,250,null,null,"24px Retro"),strokedAndFilledText("BEST",180,200,null,null,"8px Retro"),strokedAndFilledText(""+(getLocalStorageItem(game,"highScore")||0),180,250,null,null,"24px Retro")),ground.draw(),bird.draw(),input.resetKeyPressedEvents(),input.resetMouseClickEvents(),setTimeout(()=>{requestAnimationFrame(animate)},12.5)}savedHighScore&&"no data"!==savedHighScore?highScore=Number(savedHighScore):setLocalStorageItem(game,"highScore",0),requestAnimationFrame(animate);export{ctx,assets};