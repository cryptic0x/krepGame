import{setLocalStorageItem}from"../../../scripts/setLocalStorageItem.js";import{getLocalStorageItem}from"../../../scripts/getLocalStorageItem.js";const isDesktop=!window.matchMedia("(any-hover: none)").matches,isMobile=window.matchMedia("(any-hover: none)").matches,game="Taoshi Jump";let player=localStorage.getItem("player");null===player&&(player="Unknown Player");const canvas=document.querySelector("#canvas"),ctx=canvas.getContext("2d"),gameWrapper=document.querySelector("#game-wrapper"),controls=(gameWrapper.classList.add("border-2"),gameWrapper.classList.add("border-black"),document.querySelector("#game-controls")),controlsLeft=document.querySelector("#game-controls-left"),controlsRight=document.querySelector("#game-controls-right"),states=(gameWrapper.appendChild(canvas),{countdown:"Countdown",running:"Running",score:"Score",start:"Start"});if(gameWrapper.appendChild(canvas),canvas.width=375,canvas.height=564,isMobile){const maxFactor=11,windowWidth=window.innerWidth,windowHeight=window.innerHeight,widthScaleFaktor=Math.round(canvas.width/windowWidth*maxFactor)/10;windowWidth>canvas.width&&windowHeight>canvas.height*(1-widthScaleFaktor+1)&&gameWrapper.classList.add(`scale-[${1-widthScaleFaktor+1}]`)}canvas.style.imageRendering="pixelated",ctx.imageSmoothingEnabled=!1;const platformWidth=50,platformHeight=10,platformStart=canvas.height-50;let currentPlatformNumber=1;const INITIAL_BOUNCE_VELOCITY=-11,BONUS_BOUNCE_VELOCITY=-15,gravity=.33,drag=.3;let bounceVelocity=INITIAL_BOUNCE_VELOCITY,platformID=1,score=0,highScore=0,started=!1,initial=!0;setLocalStorageItem(game,"score",0);const savedHighScore=getLocalStorageItem(game,"highScore");savedHighScore&&"no data"!==savedHighScore?highScore=Number(savedHighScore):setLocalStorageItem(game,"highScore",0);let minPlatformSpace=50;const saveMinPlatformSpace=120;let maxPlatformSpace=100;const saveMaxPlatformSpace=150;ctx.textAlign="center";let platforms=[{x:canvas.width/2-platformWidth/2,y:platformStart,number:0}];function strokedAndFilledText(text="",x=0,y=0,color="white",strokeColor="black",font="40px Retro"){ctx.font=font,ctx.strokeText(text,x,y+4),ctx.lineWidth=6,ctx.strokeStyle=strokeColor,ctx.strokeText(text,x,y),ctx.fillStyle=color,ctx.fillText(text,x,y)}const assets=new Map;function random(min,max){return Math.random()*(max-min)+min}document.querySelectorAll("[data-asset]").forEach(asset=>assets.set(asset.getAttribute("data-asset"),asset));let y=platformStart;for(;0<y;){let number;number=platformID++,y-=platformHeight+random(minPlatformSpace,maxPlatformSpace);let x;for(;x=random(25,canvas.width-25-platformWidth),y>canvas.height/2&&x>canvas.width/2-1.5*platformWidth&&x<canvas.width/2+platformWidth/2;);platforms.push({x:x,y:y,number:number})}const doodle={width:40,height:84,x:canvas.width/2-20,y:platformStart-84,dx:0,dy:0};let playerDir=0,keydown=!1,prevDoodleY=doodle.y,direction="right",state=states.running;function animate(){if(setTimeout(()=>{requestAnimationFrame(animate)},12.5),setLocalStorageItem(game,"view",state),ctx.clearRect(0,0,canvas.width,canvas.height),ctx.drawImage(assets.get("clouds"),0,0),state===states.running){if(initial?doodle.dx=2:started&&(doodle.dy+=gravity),doodle.y<canvas.height/2&&doodle.dy<0){platforms.forEach(function(platform){platform.y+=-doodle.dy});for(var randomPlatformSpace=random(minPlatformSpace,maxPlatformSpace);0<platforms[platforms.length-1].y;)platforms.push({x:random(25,canvas.width-25-platformWidth),y:platforms[platforms.length-1].y-(platformHeight+randomPlatformSpace),number:platformID++}),minPlatformSpace<saveMinPlatformSpace&&(minPlatformSpace+=.5),maxPlatformSpace<saveMaxPlatformSpace&&(maxPlatformSpace+=.5)}else doodle.y+=doodle.dy;keydown||(playerDir<0?(doodle.dx+=drag,0<doodle.dx&&(doodle.dx=0,playerDir=0)):0<playerDir&&(doodle.dx-=drag,doodle.dx<0)&&(doodle.dx=0,playerDir=0)),doodle.x+=doodle.dx,doodle.x+doodle.width<0?doodle.x=canvas.width:doodle.x>canvas.width&&(doodle.x=-doodle.width),doodle.y>canvas.height&&(assets.get("die").play(),state=states.score),platforms.forEach(function(platform){const currentID=platform.number;let currentPlatformWidth=platformWidth,currentPlatformX;currentPlatformX=0===currentID?(currentPlatformWidth=canvas.width,0):(currentPlatformWidth=platformWidth,platform.x),1===currentID?(ctx.drawImage(assets.get("ground"),0,platform.y-850),ctx.drawImage(assets.get("platform"),platform.x,platform.y)):currentID%10==0?ctx.drawImage(assets.get("bird-right"),platform.x,platform.y):ctx.drawImage(assets.get("platform"),platform.x,platform.y),1===currentID?strokedAndFilledText("READY",platform.x+platformWidth/2,platform.y,"white","black","10px Retro"):2===currentID?strokedAndFilledText("SET",platform.x+platformWidth/2,platform.y,"white","black","10px Retro"):3===currentID&&strokedAndFilledText("GO",platform.x+platformWidth/2,platform.y,"white","black","10px Retro"),started?0<doodle.dy&&prevDoodleY+doodle.height<=platform.y&&doodle.x<currentPlatformX+currentPlatformWidth&&doodle.x+doodle.width>currentPlatformX&&doodle.y<platform.y+platformHeight&&doodle.y+doodle.height>platform.y&&(3<currentID?((currentID%10==0?(score+=10,assets.get("multicoin")):(score+=1,assets.get("point"))).play(),currentPlatformNumber=score+1):assets.get("jump").play(),doodle.y=platform.y-doodle.height,doodle.dy=bounceVelocity,3<currentID)&&(platforms=platforms.filter(function(platform){return platform.number!==currentID})):(score=0,strokedAndFilledText("Taoshi",192,170,"white","black","60px Retro"),strokedAndFilledText("Jump",175,227,"white","black","60px Retro"),doodle.y=platformStart-platformHeight-doodle.height,isMobile?(controls.classList.remove("hidden"),controls.classList.add("flex"),ctx.drawImage(assets.get("input-touch"),150,340)):ctx.drawImage(assets.get("input-keyboard"),150,340))}),ctx.fillStyle="transparent",ctx.drawImage(assets.get("taoshi-"+direction),doodle.x,doodle.y),ctx.fillRect(doodle.x,doodle.y,doodle.width,doodle.height),prevDoodleY=doodle.y,platforms=platforms.filter(function(platform){return platform.y<canvas.height||1===platform.number}),started&&1<currentPlatformNumber&&strokedAndFilledText(score,canvas.width/2,80,"white","black","30px Retro")}state===states.score&&0<score&&(ctx.drawImage(assets.get("ground"),0,canvas.height-1024),ctx.drawImage(assets.get("frame"),85,120),strokedAndFilledText(""+player,187,149,null,null,"9px Retro"),strokedAndFilledText("NOW",150,200,null,null,"8px Retro"),strokedAndFilledText(""+score,150,250,null,null,"24px Retro"),strokedAndFilledText("BEST",220,200,null,null,"8px Retro"),strokedAndFilledText(""+highScore,220,250,null,null,"24px Retro")),setLocalStorageItem(game,"score",score),score>highScore&&(setLocalStorageItem(game,"highScore",score),highScore=score)}setTimeout(()=>{isMobile?(controlsLeft.addEventListener("touchstart",function(e){keydown=!0,playerDir=-1,doodle.dx=-3,direction="left",initial=!1}),controlsLeft.addEventListener("touchend",function(e){keydown=!1}),controlsRight.addEventListener("touchstart",function(e){keydown=!0,playerDir=1,doodle.dx=3,direction="right",initial=!1}),controlsRight.addEventListener("touchend",function(e){keydown=!1}),canvas.addEventListener("touchstart",function(e){started=!0,initial=!1,doodle.dx=0,canvas.removeEventListener("touchstart",null)})):(document.addEventListener("keydown",function(e){37===e.which?(keydown=!0,playerDir=-1,doodle.dx=-3,direction="left",initial=!1):39===e.which?(keydown=!0,playerDir=1,doodle.dx=3,direction="right",initial=!1):38===e.which&&(started=!0,initial=!1,doodle.dx=0)}),document.addEventListener("keyup",function(e){keydown=!1}))},250),requestAnimationFrame(animate);